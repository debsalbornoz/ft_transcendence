# Architecture Analysis & Database Design Brief
**Ft_Transcendence - Lead Generation Platform**

---

## ğŸ“‹ Executive Summary

This document extracts and organizes critical architectural decisions and database design requirements for a **multi-tenant SaaS email campaign and lead generation platform**.

**Key Context:**
- Email sending is **simulated** (mock function) but events are persisted as real
- System must support **RBAC, multi-tenant isolation, event tracking, and analytics**
- Target: Health insurance brokers managing email campaigns and lead capture

---

## ğŸ—ï¸ Core Architectural Domains

### **Domain 1: Organization & Access Control (Multi-Tenant Foundation)**

#### Business Requirements
- **Multi-tenancy:** Each customer (company/broker) has completely isolated data
- **User hierarchy:** Admin and role-based permissions within organization
- **Organization membership:** Users belong to organizations with specific roles
- **Data isolation:** Queries must be organization-scoped to prevent data leakage

#### Key Entities
```
Organization
â”œâ”€â”€ name, domain, subscription_level
â”œâ”€â”€ has many Users (through Membership)
â”œâ”€â”€ owns Campaigns
â”œâ”€â”€ owns ContactLists
â””â”€â”€ owns Leads

User (global, can belong to multiple orgs)
â”œâ”€â”€ email, password_hash, oauth_profile
â””â”€â”€ through Membership â†’ Organization

Membership (User + Organization Association)
â”œâ”€â”€ user_id, organization_id
â”œâ”€â”€ role (admin, consultant, viewer, etc.)
â”œâ”€â”€ permissions (can be derived from role or explicit)
â””â”€â”€ created_at, deleted_at (soft delete for audit)

Role (RBAC Entity)
â”œâ”€â”€ name (admin, consultant, viewer)
â”œâ”€â”€ permissions (list of permission keys)
â””â”€â”€ organization_id (org-specific roles or global)

Permission
â”œâ”€â”€ key (e.g., "campaign.create", "lead.export")
â”œâ”€â”€ description
â””â”€â”€ category (campaign, lead, organization, etc.)
```

#### Critical Design Decisions
- **Soft delete recommended** for organizations and users (audit trail, GDPR compliance)
- **Membership table** allows users to belong to multiple orgs with different roles
- **Role + Permission pattern** allows flexible access control
- **Data isolation** must be enforced in every query (middleware/ORM layer)

---

### **Domain 2: Email List & Validation (Contact Management)**

#### Business Requirements
- Clients upload email lists (CSV/import)
- Platform validates emails with multiple checks:
  - Syntax validation
  - Domain validation
  - Classification (valid, invalid, risky, nonexistent)
- Store validation results for audit and segmentation
- Support historical tracking of validations

#### Key Entities
```
ContactList (Email list uploaded by client)
â”œâ”€â”€ organization_id (FK - multi-tenant)
â”œâ”€â”€ name, description
â”œâ”€â”€ source (upload, import, api, etc.)
â”œâ”€â”€ status (pending, validating, validated, failed)
â”œâ”€â”€ total_count, valid_count, invalid_count, risky_count
â”œâ”€â”€ created_by (user_id)
â”œâ”€â”€ created_at, updated_at
â””â”€â”€ deleted_at (soft delete)

Contact (Individual email in a list)
â”œâ”€â”€ organization_id (FK - multi-tenant isolation)
â”œâ”€â”€ contact_list_id (FK)
â”œâ”€â”€ email, name (optional)
â”œâ”€â”€ validation_status (valid, invalid, risky, nonexistent, etc.)
â”œâ”€â”€ validation_details (JSON: syntax_ok, domain_exists, risk_score, reason)
â”œâ”€â”€ classification (from validation)
â”œâ”€â”€ last_validated_at
â””â”€â”€ deleted_at (soft delete)

ValidationRule (System rules for email validation)
â”œâ”€â”€ rule_type (syntax, domain, classification)
â”œâ”€â”€ rule_config (JSON: patterns, domains_to_check, etc.)
â”œâ”€â”€ enabled
â””â”€â”€ version (for audit trail)

ValidationLog (Audit trail for contact validations)
â”œâ”€â”€ contact_id (FK)
â”œâ”€â”€ validation_rule_id (FK)
â”œâ”€â”€ result (pass/fail)
â”œâ”€â”€ details (JSON)
â”œâ”€â”€ validated_at
â””â”€â”€ validated_by (user_id or system)
```

#### Critical Design Decisions
- **Validation status is denormalized** in Contact table for query performance
- **Validation details stored as JSON** for flexibility (different validation types)
- **ValidationLog table** provides full audit trail (required for GDPR)
- **Soft delete** on Contact allows historical analysis without permanent removal
- **Contact list status** (pending/validating/validated) tracks bulk operation progress

#### Performance Considerations
- **Index on:** `(organization_id, validation_status)` - for filtering validated contacts
- **Index on:** `(contact_list_id, validation_status)` - for list analysis
- **Potential partitioning:** By organization_id for very large datasets
- **Archive old validations:** After 12+ months (retention policy)

---

### **Domain 3: Campaign Management**

#### Business Requirements
- Clients create email campaigns
- Each campaign has a specific landing page with a form
- Campaign links to contact lists
- Campaign tracks configuration (HTML template, form fields, etc.)
- Platform creates landing pages (not the client)

#### Key Entities
```
Campaign
â”œâ”€â”€ organization_id (FK - multi-tenant)
â”œâ”€â”€ name, description
â”œâ”€â”€ status (draft, scheduled, active, paused, completed)
â”œâ”€â”€ contact_list_id (FK - which list to send to)
â”œâ”€â”€ template_id (FK - HTML email template)
â”œâ”€â”€ form_id (FK - landing page form structure)
â”œâ”€â”€ landing_page_url (unique slug for tracking)
â”œâ”€â”€ created_by (user_id)
â”œâ”€â”€ scheduled_at, started_at, ended_at
â”œâ”€â”€ created_at, updated_at
â””â”€â”€ deleted_at (soft delete)

EmailTemplate
â”œâ”€â”€ organization_id (FK - org-specific templates or global)
â”œâ”€â”€ name, description
â”œâ”€â”€ html_content
â”œâ”€â”€ variables (JSON: list of replaceable fields)
â”œâ”€â”€ version, is_active
â”œâ”€â”€ created_by
â”œâ”€â”€ created_at, updated_at
â””â”€â”€ deleted_at (soft delete)

Form (Landing page form definition)
â”œâ”€â”€ organization_id (FK)
â”œâ”€â”€ campaign_id (FK - but could be reusable)
â”œâ”€â”€ name, description
â”œâ”€â”€ form_fields (JSON: array of field definitions)
â”œâ”€â”€ validation_rules (JSON: per-field validation)
â”œâ”€â”€ thank_you_message
â”œâ”€â”€ redirect_url (after submission)
â”œâ”€â”€ created_by
â”œâ”€â”€ created_at, updated_at
â””â”€â”€ deleted_at (soft delete)

CampaignContactAssignment
â”œâ”€â”€ campaign_id (FK)
â”œâ”€â”€ contact_id (FK)
â”œâ”€â”€ status (pending, sent, delivered, bounced, etc.)
â”œâ”€â”€ assigned_at
â””â”€â”€ scheduled_send_time (for staggered sends)
```

#### Critical Design Decisions
- **Form is separate from Campaign** (reusability, but linked 1:1 in typical flow)
- **Template versioning** allows historical tracking of email content
- **Landing page URL is unique** per campaign (tracking/analytics)
- **CampaignContactAssignment** tracks state per contact in the campaign

---

### **Domain 4: Event Tracking & Simulation (Core Analytics Data)**

#### Business Requirements
- Platform simulates email sending (mock function generates realistic events)
- Events include: sent, open, click, bounce, unsubscribe
- Events are stored for analytics dashboards
- Support real-time or near-real-time aggregation
- **High-volume writes:** Events are the largest table (millions of rows for analytics)

#### Key Entities
```
Event (Core event table - high volume)
â”œâ”€â”€ organization_id (FK - multi-tenant partition candidate)
â”œâ”€â”€ campaign_id (FK)
â”œâ”€â”€ contact_id (FK)
â”œâ”€â”€ event_type (enum: SENT, OPEN, CLICK, BOUNCE, UNSUBSCRIBE, FORM_VIEW, FORM_SUBMIT)
â”œâ”€â”€ event_data (JSON: url_clicked, bounce_reason, etc.)
â”œâ”€â”€ timestamp (event occurrence time - critical for analytics)
â”œâ”€â”€ created_at (record creation time)
â”œâ”€â”€ user_agent (device info, for opens)
â”œâ”€â”€ ip_address (anonymizable for GDPR)
â””â”€â”€ session_id (track single recipient's journey)

EventAggregation (Pre-computed summary for performance)
â”œâ”€â”€ campaign_id (FK)
â”œâ”€â”€ event_type
â”œâ”€â”€ date (aggregation key)
â”œâ”€â”€ count, unique_contacts
â”œâ”€â”€ created_at, updated_at
â””â”€â”€ is_final (locked after 24h for historical accuracy)

EmailSendSimulation (Mock service state - optional, for reproducibility)
â”œâ”€â”€ campaign_id (FK)
â”œâ”€â”€ simulation_config (JSON: send_rate, open_rate, click_rate, bounce_rate)
â”œâ”€â”€ created_by
â”œâ”€â”€ created_at
â””â”€â”€ seed (for deterministic simulation in tests)
```

#### Critical Design Decisions
- **Event table is append-only** (immutable for analytics integrity)
- **Partition by organization_id** for large deployments (easier scaling)
- **Timestamp is critical** (when event occurred, not when recorded)
- **EventAggregation** table provides fast dashboard queries (materialized view pattern)
- **Simulation config is recorded** (audit trail for reproducibility)

#### Performance Considerations
- **Composite index:** `(organization_id, campaign_id, event_type, timestamp)` for dashboard queries
- **Index on timestamp** separately for time-range queries
- **Consider table partitioning by date** if events exceed 100M+ rows
- **Archive to cold storage:** Events older than 2 years (retention policy)
- **Batch aggregation job:** Nightly recalc of EventAggregation for accuracy

---

### **Domain 5: Lead Generation & Form Responses**

#### Business Requirements
- Recipients click email link â†’ land on campaign-specific form
- Form submission creates a Lead
- Each Lead contains all form field responses
- Clients can filter/search leads by form fields
- Dynamic form fields (not predefined)

#### Key Entities
```
Lead (Generated from form submission)
â”œâ”€â”€ organization_id (FK - multi-tenant)
â”œâ”€â”€ campaign_id (FK)
â”œâ”€â”€ contact_id (FK - optional, if email was in list)
â”œâ”€â”€ form_response_id (FK - link to detailed responses)
â”œâ”€â”€ status (new, qualified, disqualified, contacted, converted)
â”œâ”€â”€ source (email_campaign, direct_form, api, etc.)
â”œâ”€â”€ created_at, updated_at
â””â”€â”€ deleted_at (soft delete for GDPR)

FormResponse (Detailed form submission data)
â”œâ”€â”€ lead_id (FK)
â”œâ”€â”€ form_id (FK)
â”œâ”€â”€ response_data (JSON: {field_key: value})
â”œâ”€â”€ submission_timestamp
â”œâ”€â”€ user_agent, ip_address
â”œâ”€â”€ session_id
â”œâ”€â”€ form_version (which version was submitted)
â””â”€â”€ created_at

FormField (Metadata about form fields for dynamic filtering)
â”œâ”€â”€ form_id (FK)
â”œâ”€â”€ field_key, field_label, field_type (text, number, select, checkbox, etc.)
â”œâ”€â”€ is_indexed (for search performance)
â”œâ”€â”€ position
â”œâ”€â”€ required
â””â”€â”€ validation_rules (JSON)
```

#### Critical Design Decisions
- **Form responses stored as JSON** for flexibility (dynamic fields)
- **FormField table** enables efficient filtering/search on arbitrary fields
- **Lead status tracking** helps clients manage sales pipeline
- **Soft delete on Lead** for GDPR while preserving analytics

#### Performance Considerations
- **Index on `(organization_id, campaign_id, status)`** for lead listing
- **Index on JSON fields** (PostgreSQL `jsonb` GIN index) for dynamic filtering
- **Denormalize high-value aggregates** into Lead table if frequently queried
- **Archive old leads** after 12 months to cold storage if needed

---

### **Domain 6: Analytics & Dashboards**

#### Business Requirements
- Clients view campaign performance dashboards
- Metrics include: sent count, open rate, click rate, bounce rate, lead conversion
- Filters: by campaign, date range, contact segment
- Export functionality: CSV, PDF

#### Key Views/Queries (Not physical tables)
```
CampaignMetrics (Logical view/query result)
â”œâ”€â”€ campaign_id
â”œâ”€â”€ date
â”œâ”€â”€ total_sent
â”œâ”€â”€ total_opens, open_rate
â”œâ”€â”€ total_clicks, click_rate
â”œâ”€â”€ total_bounces, bounce_rate
â”œâ”€â”€ total_unsubscribes
â”œâ”€â”€ leads_generated
â”œâ”€â”€ leads_conversion_rate
â””â”€â”€ (derived from Event + EventAggregation tables)

LeadSourceMetrics (Where leads came from)
â”œâ”€â”€ campaign_id
â”œâ”€â”€ source
â”œâ”€â”€ count
â””â”€â”€ conversion_rate

ContactSegmentMetrics (By validation status, etc.)
â”œâ”€â”€ campaign_id
â”œâ”€â”€ segment (valid_emails, risky_emails, invalid_emails)
â”œâ”€â”€ count_sent
â”œâ”€â”€ conversion_rate
â””â”€â”€ (derived from Contact validation_status)
```

#### Critical Design Decisions
- **Use EventAggregation table** to avoid expensive real-time calculations
- **Pre-aggregate daily metrics** in a scheduled job
- **Store results in materialized view or dedicated table** for fast dashboard loads
- **Design queries for common filters** (campaign, date range, segment)

---

### **Domain 7: Audit & Compliance (GDPR, Security)**

#### Business Requirements
- Track all user actions (creation, modification, deletion)
- Support GDPR export (all user data in structured format)
- Support GDPR deletion (right to be forgotten)
- Maintain immutable audit log

#### Key Entities
```
AuditLog (Immutable action log)
â”œâ”€â”€ organization_id (FK)
â”œâ”€â”€ user_id (FK - who performed action)
â”œâ”€â”€ entity_type (campaign, contact, lead, organization, etc.)
â”œâ”€â”€ entity_id (what was affected)
â”œâ”€â”€ action (create, update, delete, export, etc.)
â”œâ”€â”€ changes (JSON: {field: {old: x, new: y}})
â”œâ”€â”€ ip_address
â”œâ”€â”€ timestamp (when action occurred)
â”œâ”€â”€ reason (why - for compliance)
â””â”€â”€ created_at (immutable)

GDPRRequest (GDPR access/deletion requests)
â”œâ”€â”€ organization_id (FK)
â”œâ”€â”€ user_id (FK - who requested)
â”œâ”€â”€ request_type (export, deletion)
â”œâ”€â”€ status (pending, processing, completed, failed)
â”œâ”€â”€ scope (user_data, contact_data, lead_data, all)
â”œâ”€â”€ requested_at
â”œâ”€â”€ completed_at
â”œâ”€â”€ result (JSON: export URL, completion details)
â””â”€â”€ deleted_at (after compliance period)

DataDeletion (Track what was deleted for GDPR)
â”œâ”€â”€ gdpr_request_id (FK)
â”œâ”€â”€ entity_type
â”œâ”€â”€ entity_id
â”œâ”€â”€ deleted_data (JSON: anonymized copy for records)
â”œâ”€â”€ deleted_at
â””â”€â”€ reason
```

#### Critical Design Decisions
- **AuditLog is append-only** (never deleted or modified)
- **IP addresses can be anonymized** after 90 days (GDPR retention)
- **Soft delete + full audit** instead of hard delete (allows recovery, maintains history)
- **GDPRRequest table** enables tracking of compliance efforts

---

## ğŸ“Š Database Schema Overview (High Level)

### **Core Table Groups**

#### **1. Organization & Access (Tenant Foundation)**
- `organizations` - Tenant root
- `users` - Global users
- `memberships` - User-Organization mapping with roles
- `roles` - Predefined roles
- `permissions` - Permission keys

#### **2. Contact & List Management**
- `contact_lists` - Uploaded lists
- `contacts` - Individual emails
- `validation_rules` - Email validation config
- `validation_logs` - Audit trail

#### **3. Campaign & Template**
- `campaigns` - Email campaigns
- `email_templates` - Email HTML templates
- `forms` - Landing page forms
- `form_fields` - Dynamic form field definitions
- `campaign_contact_assignments` - Contact-Campaign state

#### **4. Events & Metrics (Analytics Core)**
- `events` - Individual events (HIGH VOLUME, append-only)
- `event_aggregations` - Pre-computed summaries (for dashboard performance)
- `email_send_simulations` - Mock service config (reproducibility)

#### **5. Leads**
- `leads` - Generated from form submissions
- `form_responses` - Detailed form submission data

#### **6. Compliance & Audit**
- `audit_logs` - All user actions (immutable)
- `gdpr_requests` - Compliance tracking
- `data_deletions` - Deletion history

---

## ğŸ”‘ Critical Relationships & Foreign Keys

```
Organization (root tenant)
â”œâ”€â”€ â† User [through Membership]
â”œâ”€â”€ â†’ Campaign [org_id]
â”œâ”€â”€ â†’ ContactList [org_id]
â”œâ”€â”€ â†’ EmailTemplate [org_id]
â”œâ”€â”€ â†’ Form [org_id]
â”œâ”€â”€ â†’ Event [org_id]
â”œâ”€â”€ â†’ Lead [org_id]
â””â”€â”€ â†’ AuditLog [org_id]

Campaign
â”œâ”€â”€ â†’ ContactList [contact_list_id]
â”œâ”€â”€ â†’ EmailTemplate [template_id]
â”œâ”€â”€ â†’ Form [form_id]
â”œâ”€â”€ â†’ CampaignContactAssignment [campaign_id] (multiple)
â”œâ”€â”€ â†’ Event [campaign_id] (multiple, high cardinality)
â””â”€â”€ â†’ Lead [campaign_id] (multiple)

Contact
â”œâ”€â”€ â†’ ContactList [contact_list_id]
â””â”€â”€ â†’ CampaignContactAssignment [contact_id] (multiple)

Lead
â”œâ”€â”€ â†’ Campaign [campaign_id]
â”œâ”€â”€ â†’ Contact [contact_id] (optional)
â””â”€â”€ â†’ FormResponse [form_response_id]

FormResponse
â”œâ”€â”€ â†’ Form [form_id]
â””â”€â”€ â†’ Lead [lead_id]

Event (many-to-many implicit)
â”œâ”€â”€ â†’ Campaign [campaign_id]
â”œâ”€â”€ â†’ Contact [contact_id]
â””â”€â”€ (high cardinality - millions of rows)
```

---

## ğŸ“ˆ Performance & Scaling Considerations

### **High-Volume Tables**
1. **Events table** - Append-only, millions of rows
   - Partition by `organization_id` and/or date range
   - Use materialized EventAggregation for dashboards
   - Archive old events to cold storage
   - Indexes: `(organization_id, campaign_id, timestamp)`

2. **Contact table** - Can grow large
   - Index: `(organization_id, validation_status)`
   - Batch operations for bulk import

### **Read-Heavy Operations**
- Dashboard queries: Use pre-aggregated EventAggregation
- Lead filtering: Use indexes on form_response JSONB fields
- Contact search: Use full-text search or specialized indexes

### **Write-Heavy Operations**
- Event insertion: Batch writes, consider message queue (Kafka/RabbitMQ) for high volume
- Contact creation: Bulk insert optimization
- Form submissions: Direct to database or queue

### **Recommended Indexes**

| Table | Index | Reason |
|-------|-------|--------|
| contacts | (organization_id, validation_status) | Filter by status |
| events | (organization_id, campaign_id, timestamp) | Dashboard queries |
| leads | (organization_id, campaign_id, status) | Lead listing |
| campaigns | (organization_id, status, created_at) | Campaign listing |
| audit_logs | (organization_id, created_at DESC) | Recent actions |
| form_responses | (lead_id, form_id) | Link to lead |

---

## ğŸ” Data Isolation & Security Patterns

### **Multi-Tenant Isolation**
```
Every query MUST include organization_id filter:

âŒ Bad:
SELECT * FROM contacts WHERE validation_status = 'valid'

âœ… Good:
SELECT * FROM contacts
WHERE organization_id = ? AND validation_status = 'valid'
```

### **Implementation Level**
- **ORM middleware:** Automatically append `organization_id` to queries
- **Row-level security:** PostgreSQL RLS policies (advanced)
- **Soft deletes:** Keep data for audit but exclude from queries

### **RBAC Pattern**
```
User â†’ Membership â†’ Organization
         â†“
         Role â†’ Permission

Query protection:
1. Check user has Membership in organization
2. Check user's Role has required Permission
3. Execute query scoped to organization_id
```

---

## âš–ï¸ Trade-offs & Design Decisions

### **1. Soft Delete vs Hard Delete**
| Aspect | Soft Delete | Hard Delete |
|--------|------------|------------|
| **Audit trail** | âœ… Preserved | âŒ Lost |
| **GDPR compliance** | âš ï¸ Need anonymization | âœ… Easier |
| **Query performance** | âš ï¸ Adds filter | âœ… Faster |
| **Storage** | âŒ More data | âœ… Less |

**Recommendation:** Soft delete for main entities (Contact, Campaign, Lead), hard delete after retention period.

### **2. JSON vs Normalized Tables**
| Aspect | JSON | Normalized Tables |
|--------|------|-------------------|
| **Flexibility** | âœ… Dynamic fields | âŒ Schema changes needed |
| **Query performance** | âš ï¸ Slower on complex queries | âœ… Faster joins |
| **Indexing** | âš ï¸ Limited (partial, GIN) | âœ… Full support |
| **Analytics** | âŒ Hard to aggregate | âœ… Easy |

**Recommendation:**
- Use JSON for form_response_data (truly dynamic)
- Use JSON for validation_details (auxiliary info)
- Keep core metrics denormalized for performance

### **3. Event Aggregation Table**
| Aspect | On-the-fly | Pre-aggregated |
|--------|-----------|----------------|
| **Dashboard speed** | âŒ Slow (big calculations) | âœ… Fast |
| **Data freshness** | âœ… Real-time | âš ï¸ 1-24h delay |
| **Storage** | âœ… Less | âŒ More |
| **Complexity** | âš ï¸ Complex queries | âœ… Simple views |

**Recommendation:** Pre-aggregate daily, refresh nightly.

### **4. Partitioning Strategy**
| Strategy | When | Benefit |
|----------|------|---------|
| By organization_id | 10+ orgs with large datasets | Isolation, parallel queries |
| By date | Events table | Archive old, improve speed |
| By campaign_id | Very high event volume | Parallel processing |

**Recommendation:** Start without, add if queries slow or storage exceeds 500GB.

---

## ğŸš€ Implementation Order (Dependency-Free Path)

### **Phase 1: Foundation (Week 1)**
1. Organizations, Users, Memberships, Roles, Permissions
2. ContactLists, Contacts, ValidationRules
3. Create indexes for org isolation

### **Phase 2: Campaigns & Events (Week 2)**
4. Campaigns, EmailTemplates, Forms, FormFields
5. Events table, EventAggregation
6. CampaignContactAssignment

### **Phase 3: Leads & Responses (Week 3)**
7. Leads, FormResponses
8. Implement lead creation on form submission

### **Phase 4: Analytics & Compliance (Week 4)**
9. AuditLog, GDPRRequest, DataDeletion
10. Dashboard views and query optimization

### **Phase 5: Simulation & Testing (Week 5)**
11. EmailSendSimulation table and mock service
12. Event generation logic
13. Dashboard population

---

## ğŸ“‹ Validation Checklist

### **Data Modeling**
- [ ] Every table has organization_id (except global User table)
- [ ] PK/FK relationships clearly defined
- [ ] Soft delete vs hard delete strategy decided
- [ ] JSON fields have clear validation rules

### **Performance**
- [ ] Indexes identified for all common queries
- [ ] Partitioning strategy decided (or deferred)
- [ ] Archival/retention policies defined
- [ ] Query performance tested on test data scale

### **Security & Compliance**
- [ ] Organization isolation enforced in every query
- [ ] RBAC pattern implemented
- [ ] Audit log captures all sensitive actions
- [ ] GDPR export/deletion flows designed
- [ ] PII anonymization rules defined

### **Scalability**
- [ ] Event table designed for high volume
- [ ] Aggregation strategy for dashboard performance
- [ ] Bulk operation support (import, export)
- [ ] Connection pooling considered

---

## ğŸ”— Integration Points with Application Layers

### **Next.js Application**
```
Backend (Next.js API Routes):
â”œâ”€â”€ Middleware: Auto-append organization_id to queries
â”œâ”€â”€ Middleware: Verify RBAC on each endpoint
â”œâ”€â”€ Server Actions: Handle form submissions â†’ Lead creation
â”œâ”€â”€ Server Actions: Generate events from simulated sends
â””â”€â”€ API Routes: Dashboard queries using EventAggregation

ORM Layer (Prisma):
â”œâ”€â”€ Auto-filter by organization_id where applicable
â”œâ”€â”€ Type-safe queries with included relations
â”œâ”€â”€ Aggregations for dashboard performance
â””â”€â”€ Batch operations for bulk import

Frontend (React Components):
â”œâ”€â”€ Filter contacts by validation status
â”œâ”€â”€ List/search campaigns with pagination
â”œâ”€â”€ Real-time dashboard with filtered metrics
â””â”€â”€ Export leads/contacts
```

### **Email Simulation**
```
Mock Service:
â”œâ”€â”€ Read simulation config from EmailSendSimulation table
â”œâ”€â”€ Generate events (sent, open, click, bounce) based on config
â”œâ”€â”€ Persist events to Event table
â”œâ”€â”€ Trigger aggregation job
â””â”€â”€ Update dashboard data

Deterministic Simulation:
â”œâ”€â”€ Use seed from config for reproducible results
â”œâ”€â”€ Enable testing without external SMTP
â””â”€â”€ Support performance testing at scale
```

---

## ğŸ“ Next Steps

1. **Refine data model** with actual business rules
2. **Define retention policies** (how long to keep data)
3. **Determine retention policies** (when to archive/delete)
4. **Design partition strategy** if expecting 1M+ events/day
5. **Define API contracts** for form submission, event creation
6. **Implement validation rules** for emails (syntax, domain, risk scoring)
7. **Build materialized view/aggregation job** for dashboard performance

---

**Document Version:** 0.1
**Last Updated:** January 2025
**Status:** Ready for Database Architecture Phase
