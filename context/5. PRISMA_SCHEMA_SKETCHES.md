// Prisma Schema Sketches
// Ft_Transcendence - Lead Generation Platform
// Note: These are sketches to illustrate structure, not production-ready

// ============================================================================
// PHASE 1: Organization & Access Control Foundation
// ============================================================================

// Organization (Tenant root)
model Organization {
  id              Int      @id @default(autoincrement())
  name            String   @unique
  domain          String?  @unique
  subscriptionLevel String  @default("free") // free, pro, enterprise
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  users           Membership[]
  campaigns       Campaign[]
  contactLists    ContactList[]
  contacts        Contact[]
  emailTemplates  EmailTemplate[]
  forms           Form[]
  events          Event[]
  leads           Lead[]
  auditLogs       AuditLog[]
  gdprRequests    GDPRRequest[]

  @@index([createdAt])
  @@index([deletedAt])
}

// Global User (can belong to multiple organizations)
model User {
  id              Int      @id @default(autoincrement())
  email           String   @unique
  passwordHash    String?  // null if OAuth-only
  name            String?
  oauthProfile    Json?    // { provider: "google", providerId: "...", email: "..." }
  emailVerified   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  memberships     Membership[]
  createdOrgs     Organization[] // if tracking creator
  auditLogs       AuditLog[]

  @@index([email])
  @@index([deletedAt])
}

// User-Organization Mapping with RBAC
model Membership {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  userId          Int
  roleId          Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  user            User         @relation(fields: [userId], references: [id])
  role            Role         @relation(fields: [roleId], references: [id])

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

// Role (admin, consultant, viewer, etc.)
model Role {
  id              Int      @id @default(autoincrement())
  organizationId  Int?     // null for global roles
  name            String
  description     String?
  permissions     Permission[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  memberships     Membership[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

// Permission (fine-grained access control)
model Permission {
  id              Int      @id @default(autoincrement())
  roleId          Int
  key             String   // "campaign.create", "lead.export", etc.
  category        String   // campaign, lead, organization, admin
  description     String?

  // Relations
  role            Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, key])
}

// ============================================================================
// PHASE 2: Contact Management & Validation
// ============================================================================

// Contact List (uploaded email list)
model ContactList {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  name            String
  description     String?
  source          String   // upload, import, api
  status          String   @default("pending") // pending, validating, validated, failed
  totalCount      Int      @default(0)
  validCount      Int      @default(0)
  invalidCount    Int      @default(0)
  riskyCount      Int      @default(0)
  createdBy       Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  contacts        Contact[]
  campaigns       Campaign[]

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

// Individual Contact (email entry)
model Contact {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  contactListId   Int
  email           String
  name            String?
  validationStatus String @default("pending") // valid, invalid, risky, nonexistent
  validationDetails Json?  // { syntax_ok: true, domain_exists: true, risk_score: 0.1 }
  lastValidatedAt DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  contactList     ContactList  @relation(fields: [contactListId], references: [id])
  assignments     CampaignContactAssignment[]
  events          Event[]
  leads           Lead[]
  validationLogs  ValidationLog[]

  @@unique([organizationId, email])
  @@index([organizationId, validationStatus])
  @@index([contactListId, validationStatus])
  @@index([email])
}

// Email Validation Rules
model ValidationRule {
  id              Int      @id @default(autoincrement())
  ruleType        String   // syntax, domain, classification
  ruleConfig      Json     // flexible config per rule type
  enabled         Boolean  @default(true)
  version         Int      @default(1)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  validationLogs  ValidationLog[]
}

// Validation Audit Trail
model ValidationLog {
  id              Int      @id @default(autoincrement())
  contactId       Int
  validationRuleId Int
  result          String   // pass, fail
  details         Json?    // detailed result info
  validatedAt     DateTime @default(now())
  validatedBy     Int?     // user_id or null for system

  // Relations
  contact         Contact @relation(fields: [contactId], references: [id])
  validationRule  ValidationRule @relation(fields: [validationRuleId], references: [id])

  @@index([contactId])
  @@index([validatedAt])
}

// ============================================================================
// PHASE 3: Campaign & Template System
// ============================================================================

// Email Template
model EmailTemplate {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  name            String
  description     String?
  htmlContent     String   // full HTML
  variables       String[]  // ["{{firstName}}", "{{company}}"]
  version         Int      @default(1)
  isActive        Boolean  @default(true)
  createdBy       Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  campaigns       Campaign[]

  @@index([organizationId])
  @@index([isActive])
}

// Landing Page Form Definition
model Form {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  campaignId      Int?     // typically 1:1 with campaign, but could be reusable
  name            String
  description     String?
  formFields      FormField[]
  thankYouMessage String?
  redirectUrl     String?
  createdBy       Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  campaign        Campaign?     @relation(fields: [campaignId], references: [id])
  responses       FormResponse[]

  @@index([organizationId])
  @@index([campaignId])
}

// Form Field Metadata (for indexed filtering)
model FormField {
  id              Int      @id @default(autoincrement())
  formId          Int
  fieldKey        String   // quantity_of_lives, age, etc.
  fieldLabel      String   // "Quantity of Lives", "Age"
  fieldType       String   // text, number, select, checkbox, date
  isIndexed       Boolean  @default(true) // index for search
  position        Int
  required        Boolean  @default(false)
  validationRules Json?    // { min: 1, max: 1000, pattern: "..." }
  createdAt       DateTime @default(now())

  // Relations
  form            Form     @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@unique([formId, fieldKey])
  @@index([formId])
}

// Campaign Master Record
model Campaign {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  contactListId   Int
  templateId      Int
  formId          Int
  name            String
  description     String?
  status          String   @default("draft") // draft, scheduled, active, paused, completed
  landingPageUrl  String   @unique // slug-based unique URL
  createdBy       Int
  scheduledAt     DateTime?
  startedAt       DateTime?
  endedAt         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  contactList     ContactList  @relation(fields: [contactListId], references: [id])
  template        EmailTemplate @relation(fields: [templateId], references: [id])
  form            Form         @relation(fields: [formId], references: [id])
  assignments     CampaignContactAssignment[]
  events          Event[]
  leads           Lead[]
  simulation      EmailSendSimulation?

  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([landingPageUrl])
}

// Contact-Campaign State Tracking
model CampaignContactAssignment {
  id              Int      @id @default(autoincrement())
  campaignId      Int
  contactId       Int
  status          String   @default("pending") // pending, sent, delivered, bounced, opened, clicked
  assignedAt      DateTime @default(now())
  scheduledSendTime DateTime?
  sentAt          DateTime?
  updatedAt       DateTime @updatedAt

  // Relations
  campaign        Campaign @relation(fields: [campaignId], references: [id])
  contact         Contact  @relation(fields: [contactId], references: [id])

  @@unique([campaignId, contactId])
  @@index([campaignId, status])
  @@index([contactId])
}

// ============================================================================
// PHASE 4: Event Tracking & Simulation
// ============================================================================

// Event (Append-only, high volume)
model Event {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  campaignId      Int
  contactId       Int
  eventType       String   // SENT, OPEN, CLICK, BOUNCE, UNSUBSCRIBE, FORM_VIEW, FORM_SUBMIT
  eventData       Json?    // flexible: { url_clicked: "...", bounce_reason: "..." }
  timestamp       DateTime // when event actually occurred
  userAgent       String?  // device info
  ipAddress       String?  // anonymizable for GDPR
  sessionId       String?  // track user journey
  createdAt       DateTime @default(now())

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  campaign        Campaign     @relation(fields: [campaignId], references: [id])
  contact         Contact      @relation(fields: [contactId], references: [id])

  @@index([organizationId, campaignId, eventType, timestamp(sort: Desc)])
  @@index([organizationId, timestamp(sort: Desc)])
  @@index([campaignId, timestamp(sort: Desc)])
  @@index([contactId])
}

// Event Aggregation (Pre-computed daily summaries)
model EventAggregation {
  id              Int      @id @default(autoincrement())
  campaignId      Int
  eventType       String
  date            DateTime
  count           Int
  uniqueContacts  Int
  isFinal         Boolean  @default(false) // locked after 24h
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  campaign        Campaign @relation(fields: [campaignId], references: [id])

  @@unique([campaignId, eventType, date])
  @@index([campaignId, date])
}

// Email Send Simulation Config (Mock service)
model EmailSendSimulation {
  id              Int      @id @default(autoincrement())
  campaignId      Int      @unique
  sendRate        Float    @default(1.0)   // 100% of contacts
  openRate        Float    @default(0.2)   // 20% open rate
  clickRate       Float    @default(0.1)   // 10% click rate
  bounceRate      Float    @default(0.05)  // 5% bounce rate
  unsubscribeRate Float   @default(0.01)   // 1% unsubscribe rate
  seed            Int?     // for deterministic simulation
  createdBy       Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  campaign        Campaign @relation(fields: [campaignId], references: [id])
}

// ============================================================================
// PHASE 5: Leads, Responses & Compliance
// ============================================================================

// Lead (Generated from form submission)
model Lead {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  campaignId      Int
  contactId       Int?     // optional, if email was in list
  formResponseId  Int      @unique
  status          String   @default("new") // new, qualified, disqualified, contacted, converted
  source          String   @default("email_campaign") // email_campaign, direct_form, api
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  campaign        Campaign     @relation(fields: [campaignId], references: [id])
  contact         Contact?     @relation(fields: [contactId], references: [id])
  formResponse    FormResponse @relation(fields: [formResponseId], references: [id])

  @@index([organizationId, campaignId, status])
  @@index([organizationId, createdAt])
  @@index([status])
}

// Form Response (Detailed form submission)
model FormResponse {
  id              Int      @id @default(autoincrement())
  formId          Int
  responseData    Json     // { field_key: value, ... }
  submissionTimestamp DateTime @default(now())
  userAgent       String?
  ipAddress       String?
  sessionId       String?
  formVersion     Int
  createdAt       DateTime @default(now())

  // Relations
  form            Form     @relation(fields: [formId], references: [id])
  lead            Lead?    // optional, one response can generate lead

  @@index([formId])
  @@index([submissionTimestamp])
}

// ============================================================================
// PHASE 5 (Continued): Audit & Compliance
// ============================================================================

// Audit Log (Immutable action log)
model AuditLog {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  userId          Int?     // who performed action (null for system)
  entityType      String   // campaign, contact, lead, organization, etc.
  entityId        Int
  action          String   // create, update, delete, export, etc.
  changes         Json?    // { fieldName: { old: x, new: y } }
  ipAddress       String?
  timestamp       DateTime @default(now())
  reason          String?  // compliance/audit reason
  createdAt       DateTime @default(now())

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  user            User?        @relation(fields: [userId], references: [id])

  @@index([organizationId, createdAt])
  @@index([entityType, entityId])
  @@index([userId])
}

// GDPR Request (Data export/deletion)
model GDPRRequest {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  userId          Int      // who requested
  requestType     String   // export, deletion
  status          String   @default("pending") // pending, processing, completed, failed
  scope           String   // user_data, contact_data, lead_data, all
  requestedAt     DateTime @default(now())
  completedAt     DateTime?
  result          Json?    // { export_url: "...", completion_details: "..." }
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])
  user            User         @relation(fields: [userId], references: [id])
  deletions       DataDeletion[]

  @@index([organizationId, status])
  @@index([userId])
}

// Data Deletion History (GDPR compliance trail)
model DataDeletion {
  id              Int      @id @default(autoincrement())
  gdprRequestId   Int
  entityType      String   // contact, lead, user, campaign
  entityId        Int
  deletedData     Json     // anonymized copy for records
  deletedAt       DateTime @default(now())
  reason          String?

  // Relations
  gdprRequest     GDPRRequest @relation(fields: [gdprRequestId], references: [id])

  @@index([gdprRequestId])
  @@index([entityType])
}

// ============================================================================
// Enums (for type safety)
// ============================================================================

enum OrganizationSubscriptionLevel {
  FREE
  PRO
  ENTERPRISE
}

enum MembershipRole {
  ADMIN
  CONSULTANT
  VIEWER
}

enum ContactListStatus {
  PENDING
  VALIDATING
  VALIDATED
  FAILED
}

enum ContactValidationStatus {
  PENDING
  VALID
  INVALID
  RISKY
  NONEXISTENT
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
}

enum EventType {
  SENT
  OPEN
  CLICK
  BOUNCE
  UNSUBSCRIBE
  FORM_VIEW
  FORM_SUBMIT
}

enum LeadStatus {
  NEW
  QUALIFIED
  DISQUALIFIED
  CONTACTED
  CONVERTED
}

enum GDPRRequestType {
  EXPORT
  DELETION
}

enum GDPRRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  EXPORT
  IMPORT
  ARCHIVE
  RESTORE
}

// ============================================================================
// Notes & Optimization Opportunities
// ============================================================================

/*
INDEXING STRATEGY:
- Every table should have @index on (organizationId) for multi-tenant isolation
- High-query tables need composite indexes:
  - Contact: (org_id, validation_status), (contact_list_id, status)
  - Event: (org_id, campaign_id, event_type, timestamp), (org_id, timestamp)
  - Lead: (org_id, campaign_id, status), (org_id, created_at)

SOFT DELETES:
- Used for: Organization, User, Contact, Campaign, Form, Template
- Not used for: Event (append-only), AuditLog (immutable), ValidationLog

JSONB USAGE:
- event_data: Flexible event payload
- validation_details: Validation result details
- form_fields: Complete form definition
- validation_rules: Per-field validation config
- response_data: Form submission responses
- changes: Audit trail changes
- deleted_data: GDPR deletion snapshots

PERFORMANCE NOTES:
- Event table: Consider partitioning by organization_id + date
- Aggregation: Run nightly job to pre-compute daily metrics
- Archive: Move events older than 2 years to cold storage
- Query optimization: Use EventAggregation for dashboard, not raw Event table

SCALING CONSIDERATIONS:
- Database connection pooling (PgBouncer)
- Read replicas for analytics queries
- Sharding by organization_id if multi-region
- Cache layer (Redis) for frequently accessed configs
*/
